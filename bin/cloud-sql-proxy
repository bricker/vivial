#!/usr/bin/env bash

set -eu

source $EAVE_HOME/develop/functions.bash

function run-cloud-sql-proxy() {
	if ! cmd-exists "cloud-sql-proxy"
	then
		statusmsg -e "cloud-sql-proxy is not installed in your PATH."
		statusmsg -e "Visit https://cloud.google.com/sql/docs/postgres/sql-proxy for installation instructions."
		exit 1
	fi

	local socketdir=${EAVE_HOME}/.cloudsqlproxy
	mkdir -p $socketdir

	local project=${GOOGLE_CLOUD_PROJECT:-eavefyi-dev}
	local instance=${CLOUDSQL_INSTANCE:-eave-pg-core-dev}
	cloud-sql-proxy $project:us-central1:$instance --auto-iam-authn --unix-socket $socketdir
}

run-cloud-sql-proxy