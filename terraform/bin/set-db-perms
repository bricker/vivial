#!/usr/bin/env bash

set -eu

source "${EAVE_HOME}"/develop/functions.bash

function main() (
	local metabase_instance_id="$1"

	local gcloudproject
	gcloudproject="$(e.gcloudproject)"

	local host="/run/user/1000/.cloudsqlproxy/${gcloudproject}:us-central1:eave-pg-core"
	local conndb="postgres"
	local connuser="postgres"
	local targetuser="gsa-app-mb-${metabase_instance_id}@${gcloudproject}.iam"
	local targetdb="mb_${metabase_instance_id}"

	local sql

	# Disable errexit because read returns non-zero when it reaches EOF
	set +e

	read -r -d '' sql <<-EOF
		grant "${targetuser}" to "${connuser}";
		alter database "${targetdb}" owner to "${targetuser}";
		revoke "${targetuser}" from "${connuser}";
	EOF

	set -e

	statusmsg -in "gcloudproject:"
	statusmsg -o " ${gcloudproject}"

	statusmsg -in "metabase_instance_id:"
	statusmsg -o " ${metabase_instance_id}"

	statusmsg -in "pg host:"
	statusmsg -o " ${host}"

	statusmsg -in "pg connuser:"
	statusmsg -o " ${connuser}"

	statusmsg -in "pg conndb:"
	statusmsg -o " ${conndb}"

	statusmsg -in "pg targetuser:"
	statusmsg -o " ${targetuser}"

	statusmsg -in "pg targetdb:"
	statusmsg -o " ${targetdb}"

	statusmsg -i "sql:"
	statusmsg -o -- "---"
	statusmsg -o "${sql}"
	statusmsg -o -- "---"

	echo

	if e.confirm; then
		psql \
			-h "${host}" \
			-d "${conndb}" \
			-U "${connuser}" \
			-c "${sql}"
	fi
)

main "$@"
