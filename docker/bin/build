#!/usr/bin/env bash

set -eu

source "${EAVE_HOME}"/develop/functions.bash

function _print_help () (
	statusmsg -o "Usage: build -d dirname [-p]"
	statusmsg -o "  -d dirname : Required. Directory to build, relative to the docker directory. Do not include leading or trailing slashes or dots. eg 'core-api' or 'postgres'"
	statusmsg -o "  -p : Optional. Push the image after building. (default: off)"
	statusmsg -o "  -r : Optional. Rollout the matching deployment after push. Only applicable when -p also given. (default: off)"
	statusmsg -o "  -h : Print this message."
)

function build() (
	local _dirname=""
	local _dopush=false
	local _dorollout=false

	while getopts "d:prh" argname; do
		case "$argname" in
		d) _dirname=$OPTARG ;;
		p) _dopush=true ;;
		r) _dorollout=true ;;
		h)
			_print_help
			exit 0
			;;
		*)
			statusmsg -e "unknown option: $argname"
			_print_help
			exit 1
			;;
		esac
	done

	if test -z "$_dirname"; then
		_print_help
		exit 1
	fi

	_dirname=${_dirname%%/}
	local gcloudproject; gcloudproject="$(e.gcloudproject)"
	local gitsha; gitsha="$(git rev-parse --short HEAD)"
	local imagename="us-central1-docker.pkg.dev/${gcloudproject}/docker/${_dirname}"
	local release_date; release_date=$(date --utc --iso-8601=seconds)

	docker build \
		--no-cache \
		-t "$imagename:latest" \
		-t "$imagename:$gitsha" \
		-f "$EAVE_HOME/docker/${_dirname}/Dockerfile" \
		--build-arg GAE_RELEASE_DATE="$release_date" \
		--build-arg GAE_VERSION="$gitsha" \
		"$EAVE_HOME"

	if $_dopush; then
		statusmsg -a "Pushing all tags for $imagename"
		docker push --all-tags "$imagename"

		if $_dorollout; then
			kubectl -n eave rollout restart deployment/"$_dirname"
		fi
	fi
)

build "$@"