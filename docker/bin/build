#!/usr/bin/env bash

set -eu

source "${EAVE_HOME}"/develop/functions.bash

function _print_help () (
	statusmsg -o "Usage: build -d dirname [-p]"
	statusmsg -o "  -d dirname : Required. Directory to build, relative to the docker directory. Do not include leading or trailing slashes or dots. eg 'core-api' or 'postgres'"
	statusmsg -o "  -p : Optional. Push the image after building. (default: off)"
	statusmsg -o "  -h : Print this message."
)

function build() (
	local _dirname=""
	local _dopush=false

	while getopts "d:ph" argname; do
		case "$argname" in
		d) _dirname=$OPTARG ;;
		p) _dopush=true ;;
		h)
			_print_help
			exit 0
			;;
		*)
			statusmsg -e "unknown option: $argname"
			_print_help
			exit 1
			;;
		esac
	done

	if test -z "$_dirname"; then
		_print_help
		exit 1
	fi

	local gcloudproject; gcloudproject="$(^gcloudproject)"
	local gitsha; gitsha="$(git rev-parse --short HEAD)"
	local imagename="us-central1-docker.pkg.dev/${gcloudproject}/docker/${_dirname}"

	docker build \
		-t "$imagename:latest" \
		-t "$imagename:$gitsha" \
		-f "$EAVE_HOME/docker/${_dirname}/Dockerfile" \
		"$EAVE_HOME"

	if $_dopush; then
		statusmsg -a "Pushing all tags for $imagename"
		docker push --all-tags "$imagename"
		"${EAVE_HOME}"/kube/bin/rollout -a "$_dirname"
	fi
)

build "$@"