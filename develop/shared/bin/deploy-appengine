#!/usr/bin/env bash

set -eu

source $EAVE_HOME/develop/functions.bash

function deploy () (
	local cmd="gcloud meta list-files-for-upload"

	statusmsg -i "The following files will be uploaded and deployed:"
	if verbose; then
		$cmd
	else
		$cmd | grep -v "^vendor/"
		if test -d "vendor"; then
			echo "vendor/..."
		fi
	fi

	local timestamp=$(date --utc "+%Y%m%dt%H%Mz")
	local gitrev=$(git rev-parse --short HEAD)
	local version="$timestamp-$gitrev"

	echo ""

	statusmsg -i "Diff:"
	git describe
	git --no-pager diff $(git describe)

	echo ""

	statusmsg -i "Deployment details:"
	gcloud app deploy --version=$version
	git tag -am $version $version
	git push origin $version
)

deploy