#!/usr/bin/env bash

set -eu -o pipefail

source "$EAVE_HOME"/develop/functions.bash

function main () (
	local project=""
	local app=""

	while getopts "p:a:" argname; do
		case "$argname" in
		p) project=$OPTARG ;;
		a) app=$OPTARG ;;
		*)
			statusmsg -e "unknown option: $argname"
			exit 1
			;;
		esac
	done

	if test -z "$project"; then
		statusmsg -e "project must be given with -p option."
		exit 1
	fi

	if test -z "$app"; then
		statusmsg -e "app must be given with -a option."
		exit 1
	fi

	python -m dotenv --file "${EAVE_HOME}/kube/shared/vars.share.env" run --override -- \
		python -m dotenv --file "${EAVE_HOME}/kube/$app/vars.share.env" run --override -- \
			python -m dotenv --file "${EAVE_HOME}/kube/.$project.env" run --override -- \
				yq eval-all '(.. | select(tag == "!!str")) |= envsubst(nu)' "${EAVE_HOME}/kube/$app"/*.yaml \
					| kubectl apply -f -
)

main "$@"