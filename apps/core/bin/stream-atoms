#!/usr/bin/env bash

set -eu

source "${EAVE_HOME}"/develop/functions.bash

function main () (
	source=$1
	fields=${2:-""}

	if test -z "$fields"; then
		fields="*"
	else
		fields="${fields}, metadata_insert_timestamp"
	fi

	cd "$(e.parentpath)"
	python bin/src/stream-bq.py \
		-q "select ${fields} from \`${source}\` where metadata_insert_timestamp > TIMESTAMP \"{last_insert_timestamp}\" order by timestamp limit 10" |
		jq '., "", "=======================================================================================", ""'
)

main "$@"